#!/usr/bin/env bash
# vim: set ft=sh :

SESSION_FOLDERS=("${SESSION_FOLDERS[@]:-"$HOME"}")

__select_path() {
  fd \
    --type d \
    --min-depth=0 \
    --max-depth=3 \
    --exclude .git \
    --exclude Library \
    --follow \
    . \
    "${SESSION_FOLDERS[@]}" 2>/dev/null | \
    { echo "${HOME}"; cat; } | \
    sed "s:${HOME}:~:" | \
    awk '{printf "\x1b[33m%s\x1b[0m\n", $1}' | \
    fzf --ansi --tmux bottom,75% --preview "eza -la --color=always \$(echo {} | sed \"s:~:${HOME}:\")" | \
    sed "s:~:${HOME}:"
}

__session_name() {
  local path="$1"
  local name

  # NOTE: Tmux automatically replaces . with _ if session name starts with .
  # We apply the same conversion for consistent session names on attach and create
  name="$(basename "${path}" | tr . _)"

  if [ "${name}" = "${USER}" ]; then
    name="__${name}"
  fi

  echo "${name}"
}

__create_session() {
  local name="$1"
  local path="$2"

  if ! tmux has-session -t ="${name}" 2>/dev/null; then
    TMUX='' tmux new -c "${path}" -s "${name}" -d
  fi
}

__attach_session() {
  local name="$1"

  if [ -n "${TMUX}" ]; then
    tmux switch -t "${name}"
  else
    tmux attach -t "${name}"
  fi
}

if [ -n "$1" ]; then
  path="$1"
else
  path=$(__select_path)

  if [ -z "${path}" ]; then
    exit 0
  fi
fi

name=$(__session_name "${path}")
__create_session "${name}" "${path}"
__attach_session "${name}"
