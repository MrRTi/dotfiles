#!/usr/bin/env bash
# vim: set ft=sh :
#

NOTES_FOLDER="${NOTES_FOLDER:-"$HOME/notes"}"

__select_path() {
  fd --type f . "${NOTES_FOLDER}" |
    awk '{printf "\x1b[35m%s\x1b[0m\n", $1}' |
    sed "s:${NOTES_FOLDER}/::" |
    fzf \
      --print-query \
      --ansi \
      --preview-window up,80% \
      --height=80% \
      --layout=reverse \
      --preview "bat --color=always ${NOTES_FOLDER}/{}" |
    tail -n 1
}

__create_note() {
  local query="$1"
  local file_dirname="${NOTES_FOLDER}"
  local original_query="${query}"

  # NOTE: Replace spaces with hyphens for use as a filename
  query="${query// /-}"

  # NOTE: If query contains a slash, extract subdirectory from it
  if [ ! "${query}" = "${query##*/}" ]; then
    file_dirname="${file_dirname}/$(dirname "${query}")"
  fi

  local file_name
  file_name="$(basename "${query}" | tr '[:upper:]' '[:lower:]')"
  local date
  date="$(date '+%Y-%m-%d-%H-%M-%S')"
  file_name="${date}-${file_name}.md"

  local file_path="${file_dirname}/${file_name}"

  mkdir -pv "${file_dirname}"
  touch "${file_path}"

  echo "---
  aliases:
    - ${original_query}
  tags:
    - created-from-shell
  created_at: ${date}
---

# ${original_query}
" >> "${file_path}"

  echo "${file_path}"
}

__resolve_path() {
  local selection="$1"

  if [ -f "${NOTES_FOLDER}/${selection}" ]; then
    echo "${NOTES_FOLDER}/${selection}"
  else
    __create_note "${selection}"
  fi
}

mkdir -pv "${NOTES_FOLDER}"

selection="$(__select_path)"

if [ -z "${selection}" ]; then exit 1; fi

file_path="$(__resolve_path "${selection}")"

nvim "${file_path}"
